name: Deploy

on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
        
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -euo pipefail
            APP_DIR=${{ secrets.VPS_APP_PATH || '/var/www/mactech' }}
            echo "Deploying to $APP_DIR"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            if [ ! -d .git ]; then
              echo "Initializing repo..."
              git init
              git remote add origin git@github.com:${{ github.repository }}
            fi

            echo "Fetching and checking out main..."
            git fetch origin main --depth=1
            git checkout -f main || git checkout -B main
            git reset --hard origin/main

            echo "Installing dependencies..."
            if ! command -v pnpm >/dev/null 2>&1; then
              corepack enable
              corepack prepare pnpm@9 --activate
            fi
            pnpm install --frozen-lockfile
            rm -rf .next/
            echo "Building application..."
            pnpm build

            echo "Restarting PM2..."
            pm2 restart mactech || pm2 start npm --name "mactech" -- start
            pm2 save
            echo "Deployment successful!"

      - name: Deployment Status Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "Deployment to VPS completed successfully!"
          else
            echo "Deployment failed! Check logs above for details."
            exit 1
          fi